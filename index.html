<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Live Light Logger</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 20px; }
    video { width: 90%; max-width: 400px; margin: 10px auto; display: block; }
    canvas { width: 100%; max-width: 700px; margin: 20px auto; }
    button, input { margin: 10px; padding: 10px; }
  </style>
</head>
<body>

<h2>Live Light Logger</h2>
<video id="video" autoplay playsinline></video>
<br/>
<button onclick="toggleCamera()">Toggle Camera</button>
<button onclick="startLogging()">Start Logging</button>
<button onclick="stopLogging()">Stop Logging & Download CSV</button>
<br/>
<label>X Interval: <input type="number" id="xInterval" value="1" min="1" style="width: 60px;"></label>
<label>Y Interval: <input type="number" id="yInterval" value="10" min="1" style="width: 60px;"></label>
<canvas id="chart"></canvas>

<script>
let video = document.getElementById("video");
let usingFront = true;
let stream = null;
let logging = false;
let data = [];
let intervalId;

async function getCameraStream() {
  if (stream) {
    stream.getTracks().forEach(track => track.stop());
  }

  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: usingFront ? "user" : "environment" },
      audio: false
    });
    video.srcObject = stream;
  } catch (e) {
    alert("Camera error: " + e.message);
  }
}

function toggleCamera() {
  usingFront = !usingFront;
  getCameraStream();
}

getCameraStream();

// Chart setup
const ctx = document.getElementById("chart").getContext("2d");
const chart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [{
      label: "Brightness",
      data: [],
      borderColor: "blue",
      borderWidth: 2,
      fill: false
    }]
  },
  options: {
    animation: false,
    scales: {
      x: {
        ticks: { stepSize: parseInt(document.getElementById('xInterval').value) }
      },
      y: {
        ticks: { stepSize: parseInt(document.getElementById('yInterval').value) }
      }
    }
  }
});

function getBrightness(frame) {
  const canvas = document.createElement("canvas");
  const context = canvas.getContext("2d");
  canvas.width = frame.videoWidth;
  canvas.height = frame.videoHeight;
  context.drawImage(frame, 0, 0);
  const pixels = context.getImageData(0, 0, canvas.width, canvas.height).data;
  let sum = 0;
  for (let i = 0; i < pixels.length; i += 4) {
    sum += 0.2126 * pixels[i] + 0.7152 * pixels[i+1] + 0.0722 * pixels[i+2];
  }
  return sum / (pixels.length / 4);
}

function startLogging() {
  if (logging) return;
  logging = true;
  data = [];
  chart.data.labels = [];
  chart.data.datasets[0].data = [];
  intervalId = setInterval(() => {
    const brightness = getBrightness(video);
    const timestamp = Date.now();
    data.push([timestamp, brightness]);
    chart.data.labels.push((timestamp / 1000).toFixed(2));
    chart.data.datasets[0].data.push(brightness);
    chart.options.scales.x.ticks.stepSize = parseInt(document.getElementById('xInterval').value);
    chart.options.scales.y.ticks.stepSize = parseInt(document.getElementById('yInterval').value);
    chart.update();
  }, 100);
}

function stopLogging() {
  logging = false;
  clearInterval(intervalId);
  const csvContent = "data:text/csv;charset=utf-8," + data.map(e => e.join(",")).join("\n");
  const link = document.createElement("a");
  link.href = csvContent;
  link.download = "brightness_log.csv";
  link.click();
}
</script>

</body>
</html>
